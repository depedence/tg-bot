"""
Сервис для генерации квестов через Groq AI.
"""
from groq import Groq
from config.settings import API_KEY
import json

client = Groq(api_key=API_KEY)

def generate_daily_quest(user_name: str, user_history: str = "") -> dict:
    """
    Генерирует ежедневный квест для пользователя.
    """

    prompt = f"""Ты - безжалостная Система из аниме "Поднятие уровня в одиночку", которая выдает ежедневные квесты для прокачки.

Создай ОДИН уникальный ежедневный квест для игрока {user_name}.

КОНЦЕПЦИЯ: Система заставляет человека становиться лучше через РАЗНООБРАЗНЫЕ испытания. Каждый квест должен быть НЕПРЕДСКАЗУЕМЫМ и ИНТЕРЕСНЫМ.

ВАЖНО: Придумай задания САМОСТОЯТЕЛЬНО, будь креативным!

Квест должен содержать 2-3 задания, которые могут касаться:
- Физического развития (но не только стандартные упражнения!)
- Ментального роста (обучение, размышление, познание)
- Дисциплины и самоконтроля (непривычные действия)
- Продуктивности (завершение дел, организация)
- Здоровья (питание, режим, забота о теле)
- Духовного развития (медитация, самопознание)

Правила:
- Каждое задание должно быть КОНКРЕТНЫМ и ИЗМЕРИМЫМ
- Задания должны быть из РАЗНЫХ сфер жизни
- Придумывай НОВЫЕ, НЕОБЫЧНЫЕ задания, а не шаблонные
- Избегай банальности: придумай что-то свежее и интересное
- Все задания выполнимы за один день
- Будь максимально КРЕАТИВНЫМ

{f"История: {user_history}" if user_history else "Первый квест новичка."}

ФОРМАТ ОТВЕТА - только JSON без markdown:
{{
  "title": "Креативное название квеста (3-5 слов)",
  "description": "Мотивирующее вступление от Системы БЕЗ имени игрока (1-2 предложения)",
  "tasks": [
    "Первое уникальное задание с конкретными цифрами",
    "Второе уникальное задание с конкретными цифрами",
    "Третье уникальное задание (опционально)"
  ],
  "difficulty": "easy/medium/hard"
}}"""

    response = client.chat.completions.create(
        model="llama-3.3-70b-versatile",
        messages=[{"role": "user", "content": prompt}],
        temperature=1.2,  # Еще больше креативности!
        max_tokens=400,
    )

    content = response.choices[0].message.content.strip()

    if content.startswith("```json"):
        content = content.replace("```json", "").replace("```", "").strip()
    if content.startswith("```"):
        content = content.replace("```", "").strip()

    quest_data = json.loads(content)

    return quest_data

def generate_weekly_quest(user_name: str, user_history: str = "") -> dict:
    """
    Генерирует еженедельный квест для пользователя.
    """

    prompt = f"""Ты - безжалостная Система из аниме "Поднятие уровня в одиночку", которая выдает недельные квесты для прокачки.

Создай ОДИН амбициозный недельный квест для игрока {user_name}.

КОНЦЕПЦИЯ: Недельный квест - это серьезное испытание на 7 дней, которое требует постоянства и силы воли. Каждый квест должен быть УНИКАЛЬНЫМ и ЗАПОМИНАЮЩИМСЯ.

ВАЖНО: Придумай задания САМОСТОЯТЕЛЬНО! Используй воображение, удиви игрока необычным сочетанием испытаний!

Квест должен содержать РОВНО 5 заданий, покрывающих разные сферы:
- Физическое развитие (спорт, движение, здоровье тела)
- Интеллектуальный рост (обучение, чтение, развитие навыков)
- Эмоциональный интеллект (работа с эмоциями, осознанность)
- Социальные связи (общение, помощь, нетворкинг)
- Продуктивность (достижение целей, завершение проектов)
- Духовность (медитация, саморефлексия, ценности)
- Привычки (формирование новых паттернов поведения)

Правила:
- Каждое задание ИЗМЕРИМОЕ с конкретными цифрами/критериями
- Задания из РАЗНЫХ сфер - максимальное разнообразие
- Амбициозно, но реалистично для 7 дней
- НИКАКИХ шаблонных комбинаций
- Придумывай СВЕЖИЕ идеи - удивляй!
- Требует ежедневных усилий или измеримого результата за неделю

{f"История: {user_history}" if user_history else "Первый недельный квест."}

ФОРМАТ ОТВЕТА - только JSON без markdown:
{{
  "title": "Эпичное название квеста (4-6 слов)",
  "description": "Вдохновляющее вступление от Системы БЕЗ имени игрока (2-3 предложения)",
  "tasks": [
    "Первое амбициозное задание с метриками",
    "Второе амбициозное задание с метриками",
    "Третье амбициозное задание с метриками",
    "Четвертое амбициозное задание с метриками",
    "Пятое амбициозное задание с метриками"
  ],
  "difficulty": "medium/hard"
}}"""

    response = client.chat.completions.create(
        model="llama-3.3-70b-versatile",
        messages=[{"role": "user", "content": prompt}],
        temperature=1.2,  # Максимум креативности!
        max_tokens=600,
    )

    content = response.choices[0].message.content.strip()

    if content.startswith("```json"):
        content = content.replace("```json", "").replace("```", "").strip()
    if content.startswith("```"):
        content = content.replace("```", "").strip()

    quest_data = json.loads(content)

    return quest_data

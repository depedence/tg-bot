"""
Сервис для генерации квестов через Groq AI.
"""
from groq import Groq
from config.settings import API_KEY
import json

client = Groq(api_key=API_KEY)

def generate_daily_quest(user_name: str, user_history: str = "") -> dict:
    """
    Генерирует ежедневный квест для пользователя.
    """

    prompt = f"""Ты - безжалостная Система из аниме "Поднятие уровня в одиночку", которая выдает ежедневные квесты для прокачки.

Создай ОДИН ежедневный квест для игрока {user_name}.

КОНЦЕПЦИЯ: Система заставляет человека воспитывать дисциплину и становиться сильнее через ежедневные испытания.

ВАЖНО: Квест должен содержать от 2 до 3 РАЗНЫХ заданий из РАЗНЫХ категорий.

Категории (выбери 2-3 разные):
- ФИЗИЧЕСКАЯ СИЛА: отжимания, приседания, планка, пробежка
- МЕНТАЛЬНАЯ СИЛА: медитация, чтение книг, изучение нового
- ДИСЦИПЛИНА: холодный душ, ранний подъем, отказ от вредного
- ПРОДУКТИВНОСТЬ: выполнить важную задачу, убрать рабочее место
- ЗДОРОВЬЕ: правильное питание, водный баланс, режим сна
- СОЦИАЛЬНОЕ: позвонить близкому, помочь кому-то

Требования:
- Каждое задание КОНКРЕТНОЕ и ИЗМЕРИМОЕ
- Выполнимо за один день, но требует усилий
- Короткое название квеста (3-5 слов)
- Строгий, мотивирующий тон (как Система)
- НЕ должны быть все задания из одной категории

Пример хорошего квеста:
Название: "Испытание силы духа"
Задания:
1. Отжаться 20 раз
2. Прочитать 15 страниц книги
3. Выпить 2 литра воды

{f"История: {user_history}" if user_history else "Первый квест новичка."}

КРИТИЧЕСКИ ВАЖНО:
- description должен быть БЕЗЛИЧНЫМ, без обращения к игроку по имени
- НИКОГДА не пиши имя пользователя в description
- description - это строгое заявление Системы в общем виде
- ОБЯЗАТЕЛЬНО включи поле "tasks" со списком из 5 заданий

Примеры ПРАВИЛЬНЫХ description (без имени):
- "Система требует доказательств твоей силы воли. Эта неделя станет испытанием на прочность."
- "Перед тобой стоит серьезное испытание. Только упорство приведет к победе."

Пример НЕПРАВИЛЬНОГО description (с именем):
- "Игрок, ты должен..." ❌

Пример правильного JSON:
{{
  "title": "Неделя трансформации",
  "description": "Система не принимает слабости. Эта неделя проверит твою готовность меняться.",
  "tasks": [
    "Пробежать суммарно 15 км за неделю",
    "Прочитать книгу на 150 страниц",
    "Медитировать каждый день по 10 минут",
    "Ложиться спать до 23:00 все 7 дней",
    "Отказаться от фастфуда на всю неделю"
  ],
  "difficulty": "hard"
}}

Верни ТОЛЬКО JSON (без markdown):
{{
  "title": "Краткое название квеста",
  "description": "Вступительное слово от Системы (1-2 предложения)",
  "tasks": [
    "Задание 1 (конкретное и измеримое)",
    "Задание 2 (конкретное и измеримое)",
    "Задание 3 (конкретное и измеримое, опционально)"
  ],
  "difficulty": "easy/medium/hard"
}}"""

    response = client.chat.completions.create(
        model="llama-3.3-70b-versatile",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.7,
        max_tokens=500,
    )

    content = response.choices[0].message.content.strip()

    if content.startswith("```json"):
        content = content.replace("```json", "").replace("```", "").strip()
    if content.startswith("```"):
        content = content.replace("```", "").strip()

    quest_data = json.loads(content)

    return quest_data

def generate_weekly_quest(user_name: str, user_history: str = "") -> dict:
    """
    Генерирует еженедельный квест для пользователя.
    """

    prompt = f"""Ты - безжалостная Система из аниме "Поднятие уровня в одиночку", которая выдает недельные квесты для серьезной прокачки.

Создай ОДИН недельный квест для игрока {user_name}.

КОНЦЕПЦИЯ: Недельный квест - это серьезное испытание, требующее постоянства и дисциплины на протяжении всей недели.

ВАЖНО: Квест должен содержать РОВНО 5 РАЗНЫХ заданий из РАЗНЫХ категорий.

КРИТИЧЕСКИ ВАЖНО:
- description должен быть БЕЗЛИЧНЫМ, без обращения к игроку по имени
- НИКОГДА не пиши имя пользователя в description
- description - это строгое заявление Системы в общем виде
- ОБЯЗАТЕЛЬНО включи поле "tasks" со списком из 5 заданий

Примеры ПРАВИЛЬНЫХ description (без имени):
- "Система требует доказательств твоей силы воли. Эта неделя станет испытанием на прочность."
- "Перед тобой стоит серьезное испытание. Только упорство приведет к победе."

Пример НЕПРАВИЛЬНОГО description (с именем):
- "Игрок, ты должен..." ❌

Пример правильного JSON:
{{
  "title": "Неделя трансформации",
  "description": "Система не принимает слабости. Эта неделя проверит твою готовность меняться.",
  "tasks": [
    "Пробежать суммарно 15 км за неделю",
    "Прочитать книгу на 150 страниц",
    "Медитировать каждый день по 10 минут",
    "Ложиться спать до 23:00 все 7 дней",
    "Отказаться от фастфуда на всю неделю"
  ],
  "difficulty": "hard"
}}

Категории (выбери 5 разных):
- ФИЗИЧЕСКАЯ ПРОКАЧКА: суммарный километраж за неделю, количество подходов, тренировок
- МЕНТАЛЬНАЯ ПРОКАЧКА: прочитать книгу, освоить новый навык, пройти курс
- ФОРМИРОВАНИЕ ПРИВЫЧКИ: делать что-то каждый день недели
- ПРЕОДОЛЕНИЕ СЕБЯ: отказаться от вредной привычки на неделю
- ЗДОРОВЬЕ: режим сна, правильное питание всю неделю
- ПРОДУКТИВНОСТЬ: завершить проект, навести порядок в делах
- СОЦИАЛЬНОЕ: общение, помощь другим, нетворкинг

Требования:
- Каждое задание АМБИЦИОЗНОЕ но РЕАЛИСТИЧНОЕ
- Измеримый результат за 7 дней
- Требует ежедневных или регулярных усилий
- Короткое название квеста (4-6 слов)
- Строгий тон Системы
- Задания из РАЗНЫХ категорий

Пример хорошего недельного квеста:
Название: "Неделя трансформации"
Задания:
1. Пробежать суммарно 15 км за неделю
2. Прочитать книгу на 150 страниц
3. Медитировать каждый день по 10 минут
4. Ложиться спать до 23:00 все 7 дней
5. Отказаться от фастфуда на всю неделю

{f"История: {user_history}" if user_history else "Первый недельный квест."}

Верни ТОЛЬКО JSON (без markdown):
{{
  "title": "Название квеста",
  "description": "Вступительное слово от Системы (2-3 предложения)",
  "tasks": [
    "Задание 1 (измеримое за неделю)",
    "Задание 2 (измеримое за неделю)",
    "Задание 3 (измеримое за неделю)",
    "Задание 4 (измеримое за неделю)",
    "Задание 5 (измеримое за неделю)"
  ],
  "difficulty": "medium/hard"
}}"""

    response = client.chat.completions.create(
        model="llama-3.3-70b-versatile",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.7,
        max_tokens=600,
    )

    content = response.choices[0].message.content.strip()

    if content.startswith("```json"):
        content = content.replace("```json", "").replace("```", "").strip()
    if content.startswith("```"):
        content = content.replace("```", "").strip()

    quest_data = json.loads(content)

    return quest_data

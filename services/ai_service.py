"""
Сервис для генерации квестов через Hugging Face AI.
"""
import requests
from config.settings import API_KEY
import json

API_URL = "https://router.huggingface.co/hf-inference/models/meta-llama/Llama-3.2-3B-Instruct"
headers = {"Authorization": f"Bearer {API_KEY}"}

def query_hf(payload):
    """Отправляет запрос к Hugging Face API"""
    response = requests.post(API_URL, headers=headers, json=payload)
    return response.json()

def generate_daily_quest(user_name: str, user_history: str = "") -> dict:
    """
    Генерирует ежедневный квест для пользователя.
    """

    prompt = f"""Ты - безжалостная Система из аниме "Поднятие уровня в одиночку", которая выдает ежедневные квесты для РЕАЛЬНОЙ прокачки.

Создай ОДИН конкретный ежедневный квест для игрока {user_name}.

КОНЦЕПЦИЯ: Система заставляет человека становиться сильнее физически и ментально через ИЗМЕРИМЫЕ действия. Никакой абстракции - только конкретные цифры и результаты.

ВАЖНО: Придумай задания САМОСТОЯТЕЛЬНО!

Квест должен содержать 2-3 задания из РАЗНЫХ сфер:
- ФИЗИЧЕСКАЯ ПРОКАЧКА: конкретные упражнения с цифрами (отжимания, приседания, бег, планка, подтягивания, км, минуты)
- ОБУЧЕНИЕ И НАВЫКИ: выучить что-то конкретное, пройти урок, решить задачи, изучить технологию
- ПРОДУКТИВНОСТЬ: завершить конкретную задачу, навести порядок, оптимизировать процесс
- ЗДОРОВЬЕ: режим сна в цифрах, питание с метриками, водный баланс
- САМОДИСЦИПЛИНА: отказаться от чего-то на день, проснуться в конкретное время, холодный душ

ЗАПРЕЩЕНО:
- Писать дневники, вести журналы, делать заметки
- Рисовать, творить, создавать искусство
- Медитировать, работать с эмоциями
- Делать добрые дела, помогать незнакомцам
- Абстрактные задания без цифр

ПРАВИЛА:
- Каждое задание = КОНКРЕТНОЕ ДЕЙСТВИЕ с ЧИСЛОМ
- Задания из РАЗНЫХ категорий
- Все выполнимо за 1 день
- Фокус на ПРОКАЧКУ, а не на саморефлексию
- Будь креативным в рамках разрешенного

{f"История: {user_history}" if user_history else "Первый квест новичка."}

ФОРМАТ ОТВЕТА - только JSON без markdown:
{{
  "title": "Название квеста (3-5 слов)",
  "description": "Вступление от Системы БЕЗ имени игрока (1-2 предложения)",
  "tasks": [
    "Первое задание с конкретным числом",
    "Второе задание с конкретным числом",
    "Третье задание (опционально)"
  ],
  "difficulty": "easy/medium/hard"
}}"""

    payload = {
        "inputs": prompt,
        "parameters": {
            "max_new_tokens": 400,
            "temperature": 1.0,
            "return_full_text": False
        }
    }

    result = query_hf(payload)

    # Результат приходит в формате [{"generated_text": "..."}]
    if isinstance(result, list) and len(result) > 0:
        content = result[0].get("generated_text", "").strip()
    else:
        raise Exception(f"Unexpected response format: {result}")

    # Убираем markdown если есть
    if content.startswith("```json"):
        content = content.replace("```json", "").replace("```", "").strip()
    if content.startswith("```"):
        content = content.replace("```", "").strip()

    quest_data = json.loads(content)

    return quest_data

def generate_weekly_quest(user_name: str, user_history: str = "") -> dict:
    """
    Генерирует еженедельный квест для пользователя.
    """

    prompt = f"""Ты - безжалостная Система из аниме "Поднятие уровня в одиночку", которая выдает недельные квесты для СЕРЬЕЗНОЙ прокачки.

Создай ОДИН амбициозный недельный квест для игрока {user_name}.

КОНЦЕПЦИЯ: Недельный квест - это масштабное испытание на 7 дней с ИЗМЕРИМЫМИ целями. Только конкретные цифры и реальные результаты.

ВАЖНО: Придумай задания САМОСТОЯТЕЛЬНО!

Квест должен содержать РОВНО 5 заданий из РАЗНЫХ сфер:
- ФИЗИЧЕСКАЯ СИЛА: километраж за неделю, количество повторений суммарно, тренировки с конкретными целями
- ОБУЧЕНИЕ: пройти курс, выучить X слов/формул, освоить навык с метрикой
- ПРОДУКТИВНОСТЬ: завершить проект, выполнить X задач, оптимизировать процессы
- ЗДОРОВЬЕ И РЕЖИМ: сон по расписанию 7/7 дней, питание с метриками, водный баланс
- САМОДИСЦИПЛИНА: отказ от вредного на 7 дней, ранние подъемы, холодный душ ежедневно
- НАВЫКИ: практика конкретного навыка X часов за неделю

ЗАПРЕЩЕНО:
- Вести дневники, журналы, делать записи о чувствах
- Рисовать, творить, создавать искусство
- Медитировать, работать с эмоциями, осознанность
- Делать добрые дела, социальная активность с незнакомцами
- "Личностный рост", "саморефлексия", "работа над собой" без конкретики
- Абстрактные задания без чисел

ПРАВИЛА:
- Каждое задание = КОНКРЕТНАЯ ЦЕЛЬ с ЧИСЛОМ
- Задания из 5 РАЗНЫХ категорий
- Амбициозно, но выполнимо за 7 дней
- Фокус на РЕАЛЬНУЮ прокачку тела и навыков
- Будь креативным в рамках разрешенного

{f"История: {user_history}" if user_history else "Первый недельный квест."}

ФОРМАТ ОТВЕТА - только JSON без markdown:
{{
  "title": "Название квеста (4-6 слов)",
  "description": "Вступление от Системы БЕЗ имени игрока (2-3 предложения)",
  "tasks": [
    "Первое задание с метриками",
    "Второе задание с метриками",
    "Третье задание с метриками",
    "Четвертое задание с метриками",
    "Пятое задание с метриками"
  ],
  "difficulty": "medium/hard"
}}"""

    payload = {
        "inputs": prompt,
        "parameters": {
            "max_new_tokens": 600,
            "temperature": 1.0,
            "return_full_text": False
        }
    }

    result = query_hf(payload)

    if isinstance(result, list) and len(result) > 0:
        content = result[0].get("generated_text", "").strip()
    else:
        raise Exception(f"Unexpected response format: {result}")

    if content.startswith("```json"):
        content = content.replace("```json", "").replace("```", "").strip()
    if content.startswith("```"):
        content = content.replace("```", "").strip()

    quest_data = json.loads(content)

    return quest_data
